---
title: "Incentives_Analytical_Strategy"
author: "Juan Carpio"
date: "15 January 2016"
output: html_document
---

```{r,echo=TRUE, eval=TRUE, include=FALSE}
# Reading Clean File and setting relevant libraries.

## Change working directory
setwd("C:/Users/K56CA/Dropbox/PhD/Experiments Incentives/Follow_Up_Incentives")

##Relevant libraries
library("dplyr")
library("tidyr")
library("ggplot2")
library("reshape2")
library("Hmisc")
library("leaps")
library("MASS")# Ordinal logistic regression

## read raw_data
data_clean_imp<-read.csv("clean_data.csv")
## correcting ID veriable
data_clean<- mutate(data_clean_imp, ID= X+1) %>% 
        select(ID, everything(), -X)

##Define factor variables

data_clean$r_amount <- factor(data_clean$r_amount, levels = c(1,2),
                      labels = c("£5", "£2")) 

data_clean$r_type <- factor(data_clean$r_type, levels = c(1,2),
                    labels = c("Cash", "Product")) 

data_clean$gender <- factor(data_clean$gender, levels = c(1,2),
                    labels = c("Male", "Female"))

data_clean$income <- factor(data_clean$income, levels = c(1:5),
                    labels = c("< 15k", "15k-19k",
                               "20k-29k", "> 30k", "No.Ans")) 

data_clean$employ <- factor(data_clean$employ, levels = c(1:6),
                    labels = c("FT-Emp", "PT-Emp","Unempl.", 
                               "Stud.", "Retired","Other")) 

## Addint totals for Measures: Neg.Evaluations and Expectations 

expect_1<-c("exp_x1_K","exp_x1_T", "exp_x1_S.R","exp_x1_G")
expect_2<-c("exp_x2_K","exp_x2_T", "exp_x2_S.R","exp_x2_G")
neg_eval<-c("neg.ev_1","neg.ev_2.R","neg.ev_3","neg.ev_4.R",
            "neg.ev_5","neg.ev_6","neg.ev_7.R","neg.ev_8",
            "neg.ev_9","neg.ev_10.R", "neg.ev_11","neg.ev_12")

final_df<-data_clean %>% mutate(
        tot_exp1 = rowMeans(.[expect_1]),
        tot_exp2 = rowMeans(.[expect_2]),
        tot_neg_eval = rowMeans(.[neg_eval])
        )  

# Code to audit cases ###################
# final_df %>% filter(ID==90) %>% gather()
#########################################

```

### Choices summary (Dependent variable)
```{r, cache=TRUE}
tot_choices<-cbind(count(final_df, c(vd_0f)), count(final_df, c(vd_1f)),count(final_df, c(vd_2f)))
tot_choices
```

#SIZE OF THE REWARD (£2 vs 5£)

### FUNCTION calculating t.tests comparing AMOUNT size
```{r , echo=FALSE, eval=TRUE, include=TRUE, cache=TRUE}

t<-lapply(final_df[,c(2:12,31:33)], 
          function(x) t.test(x ~ final_df[,29], var.equal = TRUE))

ps<-data.frame(p.value = sapply(t, getElement, name = "p.value"))
format(ps, scientific = FALSE) 

```

### FUNCTION calculating Mann-Whitney (Non-Parametric) comparing AMOUNT size
```{r , echo=FALSE, eval=TRUE, include=TRUE, cache=TRUE}

t<-lapply(final_df[,c(2:12,31:33)], 
          function(x) wilcox.test(x ~ final_df[,29], var.equal = TRUE))

ps<-data.frame(p.value = sapply(t, getElement, name = "p.value"))
format(ps, scientific = FALSE) 

```

### Scheme rankings and SIZE of the reward.
```{r, echo=FALSE, eval=TRUE, include=TRUE, cache=TRUE}

g2data<-melt(final_df, measure.var= c("vd_0f","vd_1f", "vd_2f"), 
         id.var = c("r_type", "r_amount"))

ggplot(g2data, aes(x=value, fill=r_amount)) +
        geom_bar(stat_count="identity",position="dodge",binwidth=1)+
        facet_grid(~variable)+
        scale_x_discrete(limit=c(1,2,3))+
        scale_fill_brewer(palette="Set1")+
        theme_bw()

#dev.copy(jpeg,"figures/prueba2.jpeg")
#dev.off()

```

#REWARD TYPE (Product vs Cash)

### FUNCTION calculating t.tests between REWARD TYPE(prod./cash)
```{r, echo=FALSE, eval=TRUE, include=TRUE, cache=TRUE}
t<-lapply(final_df[,c(2:12,31:33)], 
          function(x) t.test(x ~ final_df[,30], var.equal = TRUE))

ps<-data.frame(p.value = sapply(t, getElement, name = "p.value"))
format(ps, scientific = FALSE) 
```

### FUNCTION calculating Mann-Whitney (Non-Parametric) comparing REWARD TYPE(prod./cash)
```{r, echo=FALSE, eval=TRUE, include=TRUE ,cache=TRUE}
t<-lapply(final_df[,c(2:12,31:33)], 
          function(x) wilcox.test(x ~ final_df[,30], var.equal = TRUE))

ps<-data.frame(p.value = sapply(t, getElement, name = "p.value"))
format(ps, scientific = FALSE) 
```

## Schemes ranking and TYPE of reward.
```{r, echo=FALSE, eval=TRUE, include=TRUE, cache=TRUE}

g2data<-melt(final_df, measure.var= c("vd_0f","vd_1f","vd_2f"), 
         id.var = c("r_type", "r_amount"))

ggplot(g2data, aes(x=value, fill=r_type, y=(..count..)/sum(..count..)))+
        geom_bar(stat_count="identity",position="dodge",binwidth=1)+
        facet_grid(~variable)+
        scale_x_discrete(limit=c(1,2,3))+
        #scale_y_continuous(labels = "percentage")+
        scale_fill_brewer(palette="Set1")+
        theme_bw()



#dev.copy(jpeg,"figures/prueba2.jpeg")
#dev.off()

```



# Expectations about friends reactions.
```{r, echo=FALSE, eval=TRUE, include=TRUE, cache=TRUE}


gdata<-melt(final_df, measure.var= c("tot_exp1", "tot_exp2" ), 
         id.var = c("r_type", "r_amount"))


ggplot(gdata, aes(x=r_type, y=value, fill=variable))+
        geom_bar(stat="summary", fun.y="mean", position="dodge")+ 
        scale_y_continuous(limits =c(0,9), breaks=seq(0,9, 0.5))+
        coord_cartesian(ylim=c(0, 4.5))+
        scale_fill_brewer(palette="Set1")+
        theme_bw()

#dev.copy(jpeg,"figures/prueba2.jpeg")
#dev.off()
```

###Schemes Ranking, Type of rewards and expectation of frends reactions when sharing with 2 PEOPLE

```{r, echo=FALSE, eval=TRUE, include=TRUE, cache=TRUE}

long_data<-melt(final_df, measure.var= c("vd_0f","vd_1f","vd_2f"), 
         id.var = c("r_type", "r_amount", "tot_neg_eval", "tot_exp1", "tot_exp2"))

ggplot(long_data, aes(x = factor(value), y = tot_exp2)) +
  geom_boxplot(size = .75) +
  geom_jitter(alpha = .5) +
  facet_grid( r_type ~ r_amount, margins = FALSE) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1))+
  labs(x="Schemes Ranking", y="Expectations-sharing with 2 friends")

#dev.copy(jpeg,"figures/prueba2.jpeg")
#dev.off()
```

###Schemes Ranking, Type of rewards and expectation of frends reactions when sharing with 1 Person

```{r, echo=FALSE, eval=TRUE, include=TRUE, cache=TRUE}

long_data<-melt(final_df, measure.var= c("vd_0f","vd_1f","vd_2f"), 
         id.var = c("r_type", "r_amount", "tot_neg_eval", "tot_exp1", "tot_exp2"))

ggplot(long_data, aes(x = factor(value), y = tot_exp1)) +
  geom_boxplot(size = .75) +
  geom_jitter(alpha = .5) +
  facet_grid( r_type ~ r_amount, margins = FALSE) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1))+
  labs(x="Schemes Ranking", y="Expectations-sharing with 1 PERSON")

#dev.copy(jpeg,"figures/prueba2.jpeg")
#dev.off()
```


#Fears of Negative Evaluation Scale


### Answers distribution.
```{r, echo=FALSE, eval=TRUE, include=TRUE, cache=TRUE, error=FALSE, warning=FALSE}


g3data<-melt(final_df, measure.var= c("vd_0f","vd_1f","vd_2f"),
             id.var = c("tot_neg_eval"))


ggplot(final_df, aes(tot_neg_eval, fill=r_type))+
        geom_histogram(colour="black", binwidth=0.3)+
        scale_fill_brewer(palette="Set1")+
        facet_grid( ~r_amount, margins = FALSE) +
        theme_bw()

ggplot(final_df, aes(tot_neg_eval, fill=gender))+
        geom_histogram(colour="black", binwidth=0.3)+
        scale_fill_brewer(palette="Set1")+
        #facet_grid( ~r_amount, margins = FALSE) +
        theme_bw()

```

### Fears of negatives evaluations, and typy of reward (amount/type).
```{r, echo=FALSE, eval=TRUE, include=TRUE, cache=TRUE}

ggplot(final_df, aes(x=r_type, y=tot_neg_eval, fill=r_amount)) +
        geom_bar(stat="summary",fun.y="mean",position="dodge")+
        scale_y_continuous(limits =c(0,5), breaks=seq(0,9, 0.5))+
        coord_cartesian(ylim=c(0, 4.5))+
        scale_fill_brewer(palette="Set1")+
        theme_bw()

#dev.copy(jpeg,"figures/prueba2.jpeg")
#dev.off()
```


## Correlation Matrix

###Pearson
```{r, echo=FALSE, eval=TRUE, include=TRUE, cache=TRUE}
yy<- select(final_df, tot_exp1,tot_exp2,tot_neg_eval, 
            vd_0f, vd_2f, vd_1f, gender, income, age, employ)

yy[1:ncol(yy)] <- lapply(yy[1:ncol(yy)], function(x) as.numeric(x))

rcorr(rxy, type="pearson")                           

```
###Spearman
```{r, echo=FALSE, eval=TRUE, include=TRUE, cache=TRUE}
yy<- select(final_df, tot_exp1,tot_exp2,tot_neg_eval, 
            vd_0f, vd_2f, vd_1f, gender, income, age, employ)

yy[1:ncol(yy)] <- lapply(yy[1:ncol(yy)], function(x) as.numeric(x))

rxy<-as.matrix(yy)   
rcorr(rxy, type="spearman")                           
```

# Regression Models
```{r, echo=FALSE, comment=NA, warning=FALSE}

fit_backward <- regsubsets(mpg ~.,data = mtcars, method = "backward", nbest=1, force.in =8) 

fit_forward <- regsubsets(mpg ~.,data = mtcars, method = "forward", nbest=1, force.in =8) 


fit_step <- regsubsets(mpg ~.,data = mtcars, method = "seqrep", nbest=1, force.in =8) 


par(mfrow=c(1,2))
plot_forward<-plot(fit_forward, main = "Forward Selection")
plot_back<-plot(fit_backward, main = "Backward Selection")
```

##Model 1
```{r}

long_data<-melt(final_df, measure.var= c("vd_0f","vd_1f","vd_2f"),
        id.var = c("r_type", "r_amount", "tot_neg_eval", "tot_exp1",           "tot_exp2"))

long_data[[7]]=factor(long_data[[7]])

m1 <- polr(value ~ r_type , data = long_data, Hess=TRUE)
ctable <- coef(summary(m1))
p <- pnorm(abs(ctable[, "t value"]), lower.tail = FALSE) * 2
ctable <- cbind(ctable, "p value" = p)
ctable


```

