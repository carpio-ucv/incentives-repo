---
title: "Incentives_Core_Analysis"
author: "Juan Carpio"
date: "22 January 2016"
output: html_document
---


```{r,echo=TRUE, eval=TRUE, include=FALSE, cache=FALSE}
# Reading Clean File and setting relevant libraries.

## Change working directory
setwd("C:/Users/K56CA/Dropbox/PhD/Experiments Incentives/Follow_Up_Incentives")

##Relevant libraries
library("Hmisc")
library("dplyr")
library("tidyr")
library("ggplot2")
library("reshape2")
library("leaps")
library("car")


## read raw_data
data_clean_imp<-read.csv("clean_data.csv")
## correcting ID veriable
data_clean<- mutate(data_clean_imp, ID= X+1) %>% 
        select(ID, everything(), -X)

##Define factor variables

data_clean$r_amount <- factor(data_clean$r_amount, levels = c(1,2),
                      labels = c("£2", "£5")) 

data_clean$r_type <- factor(data_clean$r_type, levels = c(1,2),
                    labels = c("Cash", "Product")) 

data_clean$gender <- factor(data_clean$gender, levels = c(1,2),
                    labels = c("Male", "Female"))

data_clean$income <- factor(data_clean$income, levels = c(1:5),
                    labels = c("< 15k", "15k-19k",
                               "20k-29k", "> 30k", "No.Ans")) 

data_clean$employ <- factor(data_clean$employ, levels = c(1:6),
                    labels = c("FT-Emp", "PT-Emp","Unempl.", 
                               "Stud.", "Retired","Other")) 


## Adding totals for Measures: Neg.Evaluations and Expectations 

expect_1<-c("exp_x1_K","exp_x1_T", "exp_x1_S.R","exp_x1_G")
expect_2<-c("exp_x2_K","exp_x2_T", "exp_x2_S.R","exp_x2_G")
expect_all<-c("exp_x1_K","exp_x1_T", "exp_x1_S.R","exp_x1_G",
              "exp_x2_K","exp_x2_T", "exp_x2_S.R","exp_x2_G")
neg_eval<-c("neg.ev_1","neg.ev_2.R","neg.ev_3","neg.ev_4.R",
            "neg.ev_5","neg.ev_6","neg.ev_7.R","neg.ev_8",
            "neg.ev_9","neg.ev_10.R", "neg.ev_11","neg.ev_12")

final_df<-data_clean %>% mutate(
        tot_exp1 = rowMeans(.[expect_1]),
        tot_exp2 = rowMeans(.[expect_2]),
        exp_all = rowMeans(.[expect_all]),
        tot_neg_eval = rowMeans(.[neg_eval])
        )  

#final_df %>% group_by(r_amount) %>% summarise(avg = mean(age))

# Code to audit cases ###################
# final_df %>% filter(ID==90) %>% gather()
#########################################

```

## CHI SQUARE FIRST CHOICE
More than 80% prefered not to share the rward with anyone as a first choice. Such difference was highly significant. 
```{r, echo=FALSE, eval=TRUE, include=TRUE, cache=FALSE}

long_data<-melt(final_df, measure.var= c("vd_0f","vd_1f","vd_2f"),
        id.var = c("ID","r_type", "r_amount", "tot_neg_eval",
                   "tot_exp1","tot_exp2", "exp_all")) 

chi_data<- filter(long_data, value==1)

#Summarise first choice frequencies and proportions
fr<-as.matrix(table(chi_data$variable))
p <- c(fr[1,1]/nrow(chi_data), fr[2,1]/nrow(chi_data),
                fr[3,1]/nrow(chi_data)) 

#calculating chi square
fr
p
chisq.test(fr)

```



#1- First Choice preferences 

## 1.3- MULTINOMIAL REGRESSION (nnet package)
```{r, echo=FALSE, eval=TRUE, include=TRUE, cache=FALSE, message=FALSE}

library("nnet")# Multinomial regression

long_data<-melt(final_df, measure.var= c("vd_0f","vd_1f","vd_2f"),
        id.var = c("ID","r_type", "r_amount", "tot_neg_eval",
                   "tot_exp1","tot_exp2", "exp_all", "gender",
                   "income", "age", "employ")) 

mr_data<- filter(long_data, value==1)
mr_data[[3]]=as.ordered(mr_data[[3]])

## MODELS
mod1<- multinom(variable ~ r_type + exp_all + income + 
                employ + r_amount + gender + tot_neg_eval
                ,data = mr_data)
mod2<-update(mod1, . ~ . - tot_neg_eval)
mod3<-update(mod2, . ~ . - gender)
mod4<-update(mod3, . ~ . - r_amount)
mod5<-update(mod4, . ~ . - employ)

#Additional models
mod6<-update(mod4, . ~ . - income)
mod7<-update(mod4, . ~ . - exp_all)


mod1x<- multinom(variable ~ r_type, data = mr_data)   0.0126 *
mod2x<- multinom(variable ~ exp_all, data = mr_data)  0.1136
mod3x<- multinom(variable ~ income, data = mr_data)   0.03547 *
mod4x<- multinom(variable ~ employ, data = mr_data)   0.3815** s
mod5x<- multinom(variable ~ r_amount, data = mr_data) 0.6254  
mod6x<- multinom(variable ~ gender, data = mr_data)   0.6475
mod7x<- multinom(variable ~ tot_neg_eval, data = mr_data)  0.727 

mod4<
## UNIVARIABLE MODEL 
v<-c("r_type", "exp_all", "income", "employ", "r_amount",
     "gender", "tot_neg_eval")

univariable <- function(v){
        
        tab=NULL
        LR=NULL
        
        for (i in 1:length(v)){
        
        tab<-multinom(variable ~v[i], data= mr_data)
        
        LR<- Anova(tab)
        
        table<- cbind(LR$"LR Chisq", LR$Df, LR$"Pr(>Chisq)")
        print(table)
        }
}

## MODEL FRAME FUNCTION
#Function that takes a given model an return a table with relevant values, including Likelihood Ratio test. 
mod_frame <- function(m){
        
        mod<-summary(m)
        n<-length(mod$coefficients[1,])*2
#Estimate Table values        
        coef<-matrix(rbind(mod$coefficients[1,],
                   mod$coefficients[2,]),n ,1)
        se<-matrix(rbind(mod$standard.errors[1,],
                 mod$standard.errors[2,]), n,1)
        z <-matrix(rbind(mod$coefficients[1,]/mod$standard.errors[1,],
                         mod$coefficients[2,]/mod$standard.errors[2,]))
        p <-((1 - pnorm(abs(z), 0, 1))*2)
        
        odds<- exp(coef)
       
        r.deviance<-mod$deviance
        AIC<-mod$AIC
        
        coef.name<-matrix(rep(mod$vcoefnames,2),n,1)
        cond<- matrix(cbind(rep(c("1_Friend"),n/2),
                        rep(c("2_Friends"),n/2)),n,1)
#Build table        
df<- as.data.frame(cbind(cond, coef.name)) %>% 
        cbind(round(cbind(coef,se,z,p,odds),3))
colnames(df)<-c("Condition","Variable","Coeff", "Sd.Error",
                "z.value", "p.value", "odds")
print(mod$call)
print(df)

#Model doodness of fitness
fit<-(cbind(r.deviance,AIC))
colnames(fit)<-c("Residual Deviance","AIC")
print(fit)
#Likelihood Ratio Test
print(Anova(m))

}

## MODELS ESTIMATION
mod_frame(mod1)
mod_frame(mod2)
mod_frame(mod3)

```

### PROBABILITY PLOT OF THE BEST PREDICTIVE MODEL
```{r}

v.r_type<-c("Cash", "Product")
v.exp_all<-c(1:9)
v.r_amount<-c("£2", "£5")
v.income<- factor(1:5, levels = c(1:5),
        labels = c("< 15k", "15k-19k", "20k-29k", "> 30k","No.Ans")) v2.income<- factor(1, levels = c(1),labels = c("< 15k"))

dexp<-expand.grid(v.r_type, v.exp_all, v.r_amount, v2.income)
colnames(dexp)<-c("r_type", "exp_all", "r_amount", "income")


## store the predicted probabilities for each value of ses and write
pp.exp <- cbind(dexp, predict(mod5r, newdata = dexp, 
                               type = "probs", se = TRUE))

## calculate the mean probabilities within each level of ses
by(pp.exp[, 5:7], pp.exp$r_type, colMeans)

## melt data set to long for ggplot2
lpp <- melt(pp.exp, id.vars = c("exp_all", "r_type",
                "income", "r_amount"), value.name = "probability")

head(lpp) # view first few rows

## plot predicted probabilities across write values for
## each level of ses facetted by program type
ggplot(lpp, aes(x = exp_all, y = probability, colour = r_type)) +
  geom_line(size=1) +
  facet_grid(variable ~ r_amount*income, scales="free")


```




```{r,echo=FALSE, eval=TRUE, include=FALSE, cache=TRUE}

##1.1- F.C. Ordinal Logistic Regression (MASS package)

library("MASS")# Ordinal logistic regression

long_data<-melt(final_df, measure.var= c("vd_0f","vd_1f","vd_2f"),
        id.var = c("ID","r_type", "r_amount", "tot_neg_eval",
                   "tot_exp1","tot_exp2", "exp_all")) 

olr_data<- filter(long_data, value==1)


mod <- polr(variable ~ r_type+ r_amount+ exp_all,
           data = olr_data, Hess=TRUE) # Hess=true, returns 
#observed information matrix from optimization (called the Hessian) which is used to get standard errors

summary(mod)
ctable <- coef(summary(mod))
p <- as.numeric(pnorm(abs(ctable[,"t value"]), lower.tail= FALSE) *2)
p<-round(p,3)
ctable <- cbind(ctable, "p value" = p)
ctable

mod1 <- polr(variable ~ r_type+ r_amount+ exp_all+ tot_neg_eval,
           data = olr_data, Hess=TRUE)
ctable <- coef(summary(mod1))
p <- as.numeric(pnorm(abs(ctable[,"t value"]), lower.tail= FALSE) *2)
p<-round(p,3)
ctable <- cbind(ctable, "p value" = p)
ctable

```


```{r, echo=FALSE, eval=TRUE, include=FALSE, cache=FALSE}
## 1.2- F.C. ORDINAL LOGISTIC REGRESSION (ordinal package)
library("ordinal")# Ordinal logistic 
long_data<-melt(final_df, measure.var= c("vd_0f","vd_1f","vd_2f"),
        id.var = c("ID","r_type", "r_amount", "tot_neg_eval",
                   "tot_exp1","tot_exp2", "exp_all")) 

mr_data<- filter(long_data, value==1)

mod <- clm(variable ~ r_type+ r_amount+ exp_all,
           data = mr_data, Hess=TRUE)
summary(mod)


mod2 <- clm(variable ~ r_type+ r_amount+ exp_all+ tot_neg_eval,
           data = mr_data, Hess=TRUE)
summary(mod2)

mod3 <- clm(variable ~ r_type+ r_amount* exp_all + tot_neg_eval,
           data = mr_data, Hess=TRUE)
summary(mod3)

```



## 1.3- MULTINOMIAL REGRESSION (AVRI package)


### 1.1- Model Dep. Variable sharing with 2 friends
```{r, echo=FALSE, eval=TRUE, include=FALSE, cache=FALSE}
library("MASS")# Ordinal logistic 

long_data<-melt(final_df, measure.var= c("vd_2f"),
        id.var = c("r_type", "r_amount", "tot_neg_eval", "tot_exp1",
                   "tot_exp2"))

long_data[[7]]=factor(long_data[[7]])

m1 <- polr(value ~ r_type+ r_amount+ tot_exp1+ tot_exp2,
           data = long_data, Hess=TRUE)
ctable <- coef(summary(m1))
p <- as.numeric(pnorm(abs(ctable[,"t value"]), lower.tail= FALSE) *2)
p<-round(p,3)
ctable <- cbind(ctable, "p value" = p)
ctable

### ordinal regresion
mod <- clm(value ~ r_type+ r_amount+ tot_exp1+ tot_exp2,
           data = long_data)
summary(mod)



### 1.2- Model Dep. Variable sharing with 1 friend
```{r, echo=FALSE, eval=TRUE, include=TRUE, cache=TRUE}

#library("MASS")# Ordinal logistic regression

long_data<-melt(final_df, measure.var= c("vd_1f"),
        id.var = c("r_type", "r_amount", "tot_neg_eval", "tot_exp1",
                   "tot_exp2"))

long_data[[7]]=factor(long_data[[7]])

m2 <- polr(factor(vd_1f) ~ r_type+ r_amount+ tot_exp1+ tot_exp2,
           data = final_df, Hess=TRUE)
ctable <- coef(summary(m2))
p <- as.numeric(pnorm(abs(ctable[,"t value"]), lower.tail= FALSE) *2)
p<-round(p,3)
ctable <- cbind(ctable, "p value" = p)
ctable

```

### 1.3- Model Dep. Variable not sharing 
```{r,echo=FALSE, eval=TRUE, include=FALSE, cache=TRUE}

#library("MASS")# Ordinal logistic regression

long_data<-melt(final_df, measure.var= c("vd_0f"),
        id.var = c("r_type", "r_amount", "tot_neg_eval", "tot_exp1",
                   "tot_exp2"))

long_data[[7]]=factor(long_data[[7]])

m3 <- polr(factor(vd_0f) ~ r_type+ r_amount+ tot_exp1+ tot_exp2,
           data = final_df, Hess=TRUE)
ctable <- coef(summary(m3))
p <- as.numeric(pnorm(abs(ctable[,"t value"]), lower.tail= FALSE) *2)
p<-round(p,3)
ctable <- cbind(ctable, "p value" = p)
ctable

```

#1- ORDINAL LOGISTIC REGRESSION

```{r, echo=FALSE, eval=TRUE, include=FALSE, cache=FALSE}
library("ordinal")# Ordinal logistic regression

long_data<-melt(final_df, measure.var= c("vd_0f","vd_1f","vd_2f"),
        id.var = c("ID","r_type", "r_amount", "tot_neg_eval",
                   "tot_exp1","tot_exp2", "exp_all")) 

long_data[[9]]=factor(long_data[[9]])


mod <- clm(value ~ r_type+ r_amount + variable,
           data = long_data)

mod2 <- clm(value ~ r_type+ r_amount + variable + tot_neg_eval,
           data = long_data)


mod3 <- clm(value ~ r_type+ r_amount + variable + tot_neg_eval+
                    exp_all, data = long_data)

mod4 <- clm(value ~ r_type*variable + tot_neg_eval+ exp_all*r_amount, data = long_data)

mod5 <- clm(value ~ r_type+variable + tot_neg_eval+ variable*r_amount, data = long_data)


summary(mod)
summary(mod2)
summary(mod3)
```

